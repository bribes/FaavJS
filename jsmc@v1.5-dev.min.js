/* jshint esversion: 8 */
/* THIS IS A TEST VERSION OF JSMC v1.5 */

//CALCULATES NETWORK LEVEL
function getLevel(exp) {
  const EXP_NEEDED = [
    100000,
    150000,
    250000,
    500000,
    750000,
    1000000,
    1250000,
    1500000,
    2000000,
    2500000,
    2500000,
    2500000,
    2500000,
    2500000,
    3000000,
  ];
  let level = 0;
  for (let i = 0; i <= 1000; i += 1) {
    let need = 0;
    if (i >= EXP_NEEDED.length) {
      need = EXP_NEEDED[EXP_NEEDED.length - 1];
    } else {
      need = EXP_NEEDED[i];
    }
    if ((exp - need) < 0) {
      return Math.round((level + (exp / need)) * 100) / 100;
    }
    level += 1;
    exp -= need;
  }
  return 1000;
}

//CALCULATES SKYWARS LEVEL
function getSkyLevel(xp) {
  var xps = [0, 20, 70, 150, 250, 500, 1000, 2000, 3500, 6000, 10000, 15000];
  let exactLevel = 0
  if (xp >= 15000) {
    exactLevel = (xp - 15000) / 10000 + 12;
  } else {
    for (i = 0; i < xps.length; i++) {
      if (xp < xps[i]) {
        exactLevel = i + (xp - xps[i - 1]) / (xps[i] - xps[i - 1]);
        break;
      }
    }
  }
  return exactLevel;
}

//ROUNDS THE NUMBER
function roundNumber(rnum, rlength) {
  var newnumber = Math.round(rnum * Math.pow(10, rlength)) / Math.pow(10, rlength);
  return newnumber;
}

//JSMC FUNCTION
async function jsmc(a) {
  //ACCOUNT STATUS
  await fetch("https://api.gapple.pw/blocked/" + a).then(a => a.json()).then(e => {
    player = new Object({}),
      player.status = e.status,
      "blocked" == player.status && !1 === /^[a-zA-Z0-9_]{3,16}$/.test(a) && (player.status = "invalid"),

      //ACCOUNT TYPE
      fetch("https://api.gapple.pw/status/" + a).then(a => a.json()).then(e => {
        player.type = e.status,

          //BASIC PLAYER INFO
          fetch("https://playerdb.co/api/player/minecraft/" + a).then(a => a.json()).then(a => {
            player.error = !1,
              player.username = a.data.player.username,
              player.uuid = a.data.player.id,
              player.id = a.data.player.raw_id,
              player.name_history = a.data.player.meta.name_history,
              player.icon = `https://crafatar.com/avatars/${player.id}?overlay`,
              player.avatar = `https://crafatar.com/renders/body/${player.id}?overlay`,
              player.head = `https://crafatar.com/renders/head/${player.id}?overlay`,
              player.skin = `https://crafatar.com/skins/${player.id}`,

              //COSMETICS
              player.cosmetics = new Object({}),

              //CAPES
              player.cosmetics.cape = new Object({}),
              player.cosmetics.cape.official = `https://crafatar.com/capes/${player.id}`,
              player.cosmetics.cape.optifine = `https://api.gapple.pw/cors/optifine/${player.username}`,
              player.cosmetics.cape.labymod = `https://api.gapple.pw/cors/labymod/cape/${player.id}`,
              player.cosmetics.bandana = new Object({}),

              //BANDANAS
              player.cosmetics.bandana.labymod = `https://api.gapple.pw/cors/labymod/bandana/${player.id}`,

              //SERVERS
              fetch("https://api.hypixel.net/player?key=63f20355-92d7-42d7-a2a5-6457160aa4eb&uuid=" + player.id).then(a => a.json()).then(a => {
                player.servers = new Object({}),

                  //HYPIXEL
                  player.servers.hypixel = new Object({}),
                  player.servers.hypixel.success = a.success,
                  null !== a.player && (player.servers.hypixel.rank = a.player.rank,
                    player.servers.hypixel.newPackageRank = a.player.newPackageRank,
                    player.servers.hypixel.monthlyPackageRank = a.player.monthlyPackageRank,
                    player.servers.hypixel.firstLogin = a.player.firstLogin,
                    player.servers.hypixel.lastLogin = a.player.lastLogin,
                    player.servers.hypixel.lastLogout = a.player.lastLogout,
                    player.servers.hypixel.networkExp = a.player.networkExp,
                    player.servers.hypixel.networkLevel = roundNumber((Math.sqrt((2 * player.servers.hypixel.networkExp) + 30625) / 50) - 2.5, 2),
                    player.servers.hypixel.karma = a.player.karma,

                    //HYPIXEL SKYWARS STATS
                    player.servers.hypixel.skywars = new Object({}),
                    player.servers.hypixel.skywars.games_played = a.player.stats.SkyWars.games_played_skywars,
                    player.servers.hypixel.skywars.exp = a.player.stats.SkyWars.skywars_experience),
                  player.servers.hypixel.skywars.level = roundNumber(getSkyLevel(player.servers.hypixel.skywars.exp), 2),
                  player.servers.hypixel.skywars.levelFormatted = a.player.stats.SkyWars.levelFormatted,
                  player.servers.hypixel.skywars.win_streak = a.player.stats.SkyWars.win_streak,
                  player.servers.hypixel.skywars.wins = a.player.stats.SkyWars.wins,
                  player.servers.hypixel.skywars.losses = a.player.stats.SkyWars.losses,
                  player.servers.hypixel.skywars.kills = a.player.stats.SkyWars.kills,
                  player.servers.hypixel.skywars.deaths = a.player.stats.SkyWars.deaths,
                  player.servers.hypixel.skywars.assists = a.player.stats.SkyWars.assists,
                  player.servers.hypixel.skywars.kd = roundNumber(player.servers.hypixel.skywars.kills / player.servers.hypixel.skywars.deaths, 2),
                  player.servers.hypixel.skywars.wl = roundNumber(player.servers.hypixel.skywars.wins / player.servers.hypixel.skywars.losses, 2),
                  player.servers.hypixel.skywars.coins = a.player.stats.SkyWars.coins,
                  player.servers.hypixel.skywars.time_played = a.player.stats.SkyWars.time_played,
                  player.servers.hypixel.skywars.souls = a.player.stats.SkyWars.souls,
                  player.servers.hypixel.skywars.quits = a.player.stats.SkyWars.quits;

                //HYPIXEL SKYWARS SOLO
                player.servers.hypixel.skywars.solo = new Object({}),
                  player.servers.hypixel.skywars.solo.games_played = a.player.stats.SkyWars.games_solo,
                  player.servers.hypixel.skywars.solo.wins = a.player.stats.SkyWars.wins_solo,
                  player.servers.hypixel.skywars.solo.losses = a.player.stats.SkyWars.losses_solo,
                  player.servers.hypixel.skywars.solo.kills = a.player.stats.SkyWars.kills_solo,
                  player.servers.hypixel.skywars.solo.deaths = a.player.stats.SkyWars.deaths_solo,
                  player.servers.hypixel.skywars.solo.assists = a.player.stats.SkyWars.assists_solo,
                  player.servers.hypixel.skywars.solo.time_played = a.player.stats.SkyWars.time_played_solo,
                  player.servers.hypixel.skywars.solo.kd = roundNumber(player.servers.hypixel.skywars.solo.kills / player.servers.hypixel.skywars.solo.deaths, 2),
                  player.servers.hypixel.skywars.solo.wl = roundNumber(player.servers.hypixel.skywars.solo.wins / player.servers.hypixel.skywars.solo.losses, 2);

                //HYPIXEL SKYWARS DOUBLES
                player.servers.hypixel.skywars.doubles = new Object({}),
                  player.servers.hypixel.skywars.doubles.games_played = a.player.stats.SkyWars.games_team,
                  player.servers.hypixel.skywars.doubles.wins = a.player.stats.SkyWars.wins_team
                player.servers.hypixel.skywars.doubles.losses = a.player.stats.SkyWars.losses_team
                player.servers.hypixel.skywars.doubles.kills = a.player.stats.SkyWars.kills_team,
                  player.servers.hypixel.skywars.doubles.deaths = a.player.stats.SkyWars.deaths_team,
                  player.servers.hypixel.skywars.doubles.assists = a.player.stats.SkyWars.assists_team,
                  player.servers.hypixel.skywars.doubles.time_played = a.player.stats.SkyWars.time_played_team,
                  player.servers.hypixel.skywars.doubles.kd = roundNumber(player.servers.hypixel.skywars.doubles.kills / player.servers.hypixel.skywars.doubles.deaths, 2),
                  player.servers.hypixel.skywars.doubles.wl = roundNumber(player.servers.hypixel.skywars.doubles.wins / player.servers.hypixel.skywars.doubles.losses, 2);

                //HYPIXEL PLAYER STATUS
                fetch("https://api.hypixel.net/status?key=63f20355-92d7-42d7-a2a5-6457160aa4eb&uuid=" + player.id).then(a => a.json()).then(a => {
                    player.servers.hypixel.online = a.session.online;
                  }),

                  //HYPIXEL GUILD
                  fetch("https://api.hypixel.net/guild?key=63f20355-92d7-42d7-a2a5-6457160aa4eb&player=" + player.id).then(a => a.json()).then(e => {
                    player.servers.hypixel.guild = new Object({});
                    player.servers.hypixel.guild.success = e.success;
                    if (e.guild !== null) {
                      player.servers.hypixel.guild.id = e.guild._id,
                        player.servers.hypixel.guild.name = e.guild.name,
                        player.servers.hypixel.guild.createdAt = e.guild.created,
                        player.servers.hypixel.guild.members = e.guild.members,
                        player.servers.hypixel.guild.ranks = e.guild.ranks,
                        player.servers.hypixel.guild.exp = e.guild.exp,
                        player.servers.hypixel.guild.level = roundNumber(getLevel(player.servers.hypixel.guild.exp), 0),
                        player.servers.hypixel.guild.tag = e.guild.tag,
                        player.servers.hypixel.guild.tagColor = e.guild.tagColor,
                        player.servers.hypixel.guild.coins = e.guild.coins,
                        player.servers.hypixel.guild.coinsEver = e.guild.coinsEver,
                        player.servers.hypixel.guild.expByGameType = e.guild.guildExpByGameType;
                    }
                    //RUNS THE USERS CODE
                    code();
                  });
              }).catch(a => player.error = !0); //CATCHES ERROR
          });
      });
  });
}
